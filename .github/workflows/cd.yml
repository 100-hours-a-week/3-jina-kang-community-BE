name: Backend CD

on:
  workflow_run:
    workflows: ["Backend CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    strategy:
      matrix:
        include:
          - name: AZ-A
            host: ${{ secrets.EC2_HOST_AZ_A_BACKEND }}
            db_host: ${{ secrets.DB_HOST_MASTER }}
          - name: AZ-B
            host: ${{ secrets.EC2_HOST_AZ_B_BACKEND }}
            db_host: ${{ secrets.DB_HOST_REPLICA }}

    steps:
      - name: Deploy to ${{ matrix.name }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ matrix.host }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment on ${{ matrix.name }}..."
            
            # ECR Î°úÍ∑∏Ïù∏
            aws ecr get-login-password --region ap-northeast-2 | \
              docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
            
            # ÏµúÏã† Ïù¥ÎØ∏ÏßÄ pull
            docker pull ${{ secrets.ECR_REGISTRY }}/backend-app:latest
            
            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è Ï†úÍ±∞
            docker stop backend-app || true
            docker rm backend-app || true
            
            # ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
            docker run -d \
              --name backend-app \
              --restart unless-stopped \
              -p 8080:8080 \
              -e DB_HOST=${{ matrix.db_host }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e JWT_ACCESS_EXPIRATION=${{ secrets.JWT_ACCESS_EXPIRATION }} \
              -e JWT_REFRESH_EXPIRATION=${{ secrets.JWT_REFRESH_EXPIRATION }} \
              -e JWT_FILE_EXPIRATION=${{ secrets.JWT_FILE_EXPIRATION }} \
              -e ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }} \
              -e S3_BUCKET=${{ secrets.S3_BUCKET }} \
              -e CLOUDFRONT_DOMAIN=${{ secrets.CLOUDFRONT_DOMAIN }} \
              -e API_GATEWAY_UPLOAD_URL=${{ secrets.API_GATEWAY_UPLOAD_URL }} \
              ${{ secrets.ECR_REGISTRY }}/backend-app:latest
            
            # Ìó¨Ïä§ Ï≤¥ÌÅ¨ ÎåÄÍ∏∞
            echo "‚è≥ Waiting for application to start..."
            sleep 30
            
            # Ìó¨Ïä§ Ï≤¥ÌÅ¨
            if curl -f http://localhost:8080/actuator/health; then
              echo "‚úÖ Deployment successful on ${{ matrix.name }}!"
            else
              echo "‚ùå Health check failed on ${{ matrix.name }}"
              exit 1
            fi
            
            # Ïù¥Ï†Ñ Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
            docker image prune -f
            
            echo "üéâ Deployment completed on ${{ matrix.name }}"